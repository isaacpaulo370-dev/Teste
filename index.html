<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sequ√™ncia de 3 Cadeados</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    html,body,#map{ height:100%; margin:0; padding:0; }
    body{ font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .lock-marker{ font-size:26px; line-height:26px; }
    .popup-form{ display:flex; gap:8px; align-items:center; }
    .popup-form input{ padding:6px; font-size:14px; }
    .popup-success{ color:green; font-weight:700; }
    .popup-fail{ color:crimson; font-weight:700; }
    .topbar{ position:absolute; left:10px; top:10px; z-index:1000; background:#fff; padding:8px 12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.15); }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="topbar">Desbloqueie os 3 cadeados em sequ√™ncia (1 ‚Üí 2 ‚Üí 3).</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // Cadeados em ordem ‚Äî senhas fornecidas pelo usu√°rio
    const locks = [
      {idx:0, id: 'c1', title: 'Cadeado 1 - Am√©rica do Norte', coords: [40.7128, -74.0060], password: 'Isaac newton', unlocked:false},
      {idx:1, id: 'c2', title: 'Cadeado 2 - Europa', coords: [51.5074, -0.1278], password: 'Jully', unlocked:false},
      {idx:2, id: 'c3', title: 'Cadeado 3 - √Åsia', coords: [35.6762, 139.6503], password: 'Samuel', unlocked:false}
    ];

    let unlockedCount = 0; // quantos j√° foram desbloqueados em sequ√™ncia

    const map = L.map('map', { zoomControl:true }).setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    function makeLockIcon(isUnlocked){
      return L.divIcon({ className: 'lock-marker', html: isUnlocked ? 'üîì' : 'üîí' });
    }

    // Cria marcadores e popups
    locks.forEach(lock => {
      lock.marker = L.marker(lock.coords, { icon: makeLockIcon(lock.unlocked) }).addTo(map);

      const popupId = 'popup-' + lock.id;
      const html = `
        <div>
          <div style="font-weight:700;margin-bottom:6px;">${lock.title}</div>
          <div id="${popupId}-msg"></div>
          <form id="${popupId}-form" class="popup-form" onsubmit="return false;">
            <input id="${popupId}-input" placeholder="Digite a senha" autocomplete="off" />
            <button id="${popupId}-btn" type="button">Desbloquear</button>
          </form>
        </div>
      `;

      lock.marker.bindPopup(html,{ minWidth:220 });

      lock.marker.on('popupopen', () => {
        const btn = document.getElementById(popupId + '-btn');
        const input = document.getElementById(popupId + '-input');
        const msg = document.getElementById(popupId + '-msg');

        // Se j√° desbloqueado, mostra que est√° aberto
        if(lock.unlocked){
          msg.innerHTML = `<div class="popup-success">Desbloqueado! &nbsp;"${lock.password}"</div>`;
          input.style.display = 'none';
          btn.style.display = 'none';
          return;
        }

        // Verifica se √© a vez deste cadeado
        if(lock.idx !== unlockedCount){
          msg.innerHTML = `<div class="popup-fail">Bloqueado. Primeiro desbloqueie o Cadeado ${unlockedCount + 1}.</div>`;
          input.disabled = true;
          btn.disabled = true;
          return;
        }

        // Caso seja a vez correta, habilita input
        msg.innerHTML = '';
        input.disabled = false;
        btn.disabled = false;

        function tryUnlock(){
          const attempt = (input.value || '').trim().toLowerCase();
          const correct = (lock.password || '').trim().toLowerCase();
          if(attempt === correct){
            lock.unlocked = true;
            unlockedCount = Math.max(unlockedCount, lock.idx + 1);
            msg.innerHTML = `<div class="popup-success">Senha correta! &nbsp;"${lock.password}"</div>`;
            input.style.display = 'none';
            btn.style.display = 'none';
            // Atualiza √≠cone do marcador
            lock.marker.setIcon(makeLockIcon(true));

            // Se houver pr√≥ximo cadeado, centraliza e abre o pr√≥ximo popup ap√≥s breve pausa
            if(unlockedCount < locks.length){
              const next = locks[unlockedCount];
              setTimeout(()=>{
                map.setView(next.coords, 4, { animate:true });
                next.marker.openPopup();
              }, 700);
            } else {
              // todos desbloqueados
              setTimeout(()=>{
                map.fitBounds(locks.map(l=>l.coords), { padding:[50,50] });
                alert('Parab√©ns ‚Äî todos os cadeados foram desbloqueados!');
              }, 600);
            }
          } else {
            msg.innerHTML = `<div class="popup-fail">Senha incorreta. Tente novamente.</div>`;
          }
        }

        btn.onclick = tryUnlock;
        input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') tryUnlock(); });
      });
    });

    // Abre automaticamente o primeiro cadeado ao carregar
    window.addEventListener('load', ()=>{
      map.setView(locks[0].coords, 4);
      locks[0].marker.openPopup();
    });
  </script>
</body>
</html>
